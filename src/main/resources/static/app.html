<!doctype html>
<html>
<head><meta charset="utf-8"><title>App</title></head>
<body style="font-family:system-ui;margin:40px">
<h2>App Test</h2>
<button onclick="me()">GET /api/auth/me</button>
<button onclick="refresh()">POST /api/auth/refresh</button>
<button onclick="logout()">POST /api/auth/logout</button>
<pre id="out"></pre>

<script>
    const out = document.getElementById("out");
    const show = x => out.textContent = typeof x === "string" ? x : JSON.stringify(x,null,2);

    // google redirect -> tokens in URL fragment
    if (location.hash.includes("access=")) {
        const p = new URLSearchParams(location.hash.substring(1));
        localStorage.setItem("accessToken", p.get("access"));
        localStorage.setItem("refreshToken", p.get("refresh"));
        history.replaceState({}, "", "/app.html");
    }

    async function me(){
        const token = localStorage.getItem("accessToken");
        const res = await fetch("/api/auth/me", { headers: { "Authorization": "Bearer " + token }});
        show({status: res.status, text: await res.text()});
    }

    async function refresh(){
        const refreshToken = localStorage.getItem("refreshToken");
        const res = await fetch("/api/auth/refresh", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ refreshToken })
        });
        const data = await res.json();
        localStorage.setItem("accessToken", data.accessToken);
        localStorage.setItem("refreshToken", data.refreshToken);
        show(data);
    }

    async function logout(){
        const refreshToken = localStorage.getItem("refreshToken");
        const res = await fetch("/api/auth/logout", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ refreshToken })
        });
        localStorage.removeItem("accessToken");
        localStorage.removeItem("refreshToken");
        show({status: res.status, text: await res.text()});
    }
</script>
</body>
</html>
