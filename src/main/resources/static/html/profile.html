<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ - AI Luật</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/img/Law.png">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/credits-counter.css">
    <link rel="stylesheet" href="/css/profile.css">
    <link rel="stylesheet" href="/css/toast-notification.css">

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
        <a class="navbar-brand" href="/index.html">
            <img src="/img/Law.png" alt="Logo">
            <span>Pháp Luật Số</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-lg-center">
                <li class="nav-item"><a class="nav-link" href="/index.html">Trang chủ</a></li>
                <li class="nav-item"><a class="nav-link" href="/html/about.html">Về chúng tôi</a></li>
                <li class="nav-item"><a class="nav-link" href="/html/legal-chat.html">Chat AI</a></li>
                <li class="nav-item"><a class="nav-link" href="/html/my-quizzes.html">Bộ đề</a></li>
                <li class="nav-item"><a class="nav-link" href="/html/legal-upload.html">Văn bản PL</a></li>
                <li class="nav-item"><a class="nav-link" href="/html/guide.html">Hướng dẫn</a></li>
                <li class="nav-item"><a class="nav-link" href="/html/contact.html">Liên hệ</a></li>
                <li class="nav-item ms-lg-3 guest-only">
                    <a class="btn btn-outline-primary btn-sm px-3" href="/html/login.html">
                        <i class="bi bi-box-arrow-in-right me-1"></i>Đăng Nhập
                    </a>
                </li>
                <li class="nav-item ms-lg-2 guest-only">
                    <a class="btn btn-primary btn-sm px-3" href="/html/register.html">
                        <i class="bi bi-person-plus me-1"></i>Đăng Ký
                    </a>
                </li>
                <li class="nav-item dropdown ms-lg-3 auth-only d-none">
                    <a class="nav-link dropdown-toggle p-0" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <img id="navUserAvatar" src="https://ui-avatars.com/api/?name=User&size=40&background=1a4b84&color=fff" 
                             alt="Avatar" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover; border: 2px solid #e2e8f0;">
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="/html/profile.html"><i class="bi bi-person me-2"></i>Hồ sơ</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="navLogoutBtn"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Profile Header -->
<div class="profile-header">
    <div class="container">
        <h1><i class="bi bi-person-circle me-2"></i>Hồ Sơ Cá Nhân</h1>
        <p class="mb-0 opacity-75" style="font-size: 0.9rem;">Quản lý thông tin tài khoản và bảo mật</p>
    </div>
</div>

<div class="profile-container">
    <div class="row g-3">
        <!-- Left Column: Avatar & Stats -->
        <div class="col-lg-4">
            <div class="profile-avatar-card">
                <img id="profileAvatar" src="/img/default-avatar.png" alt="Avatar" class="profile-avatar" 
                     onerror="this.src='https://ui-avatars.com/api/?name=User&size=140&background=1a4b84&color=fff'">
                
                <h3 id="profileFullName">Đang tải...</h3>
                <p id="profileEmail" class="text-muted">email@example.com</p>
                
                <label for="avatarInput" class="btn btn-outline-primary btn-sm avatar-upload-btn w-100 mb-2">
                    <i class="bi bi-camera me-1"></i>Đổi ảnh đại diện
                    <input type="file" id="avatarInput" accept="image/*">
                </label>
                <small class="text-muted d-block" style="font-size: 0.75rem;">JPG, PNG, GIF. Max 5MB</small>
                
                <div class="profile-stats">
                    <div class="profile-stat">
                        <span class="profile-stat-number">0</span>
                        <span class="profile-stat-label">Quiz</span>
                    </div>
                    <div class="profile-stat">
                        <span class="profile-stat-number">0</span>
                        <span class="profile-stat-label">Điểm</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Info & Password -->
        <div class="col-lg-8">
            <div class="row g-3">
                <!-- Credits Information Card -->
                <div class="col-12">
                    <div class="profile-card">
                        <h5 class="profile-card-title">
                            <i class="bi bi-wallet2"></i>
                            Thông tin Credits
                        </h5>
                        
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="profile-info-item">
                                    <div class="profile-info-label">
                                        <i class="bi bi-chat-dots"></i>Chat Credits
                                    </div>
                                    <div class="profile-info-value">
                                        <span id="chatCreditsValue" class="text-primary fw-bold">--</span> lượt
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="profile-info-item">
                                    <div class="profile-info-label">
                                        <i class="bi bi-robot"></i>AI Tạo Đề
                                    </div>
                                    <div class="profile-info-value">
                                        <span id="quizGenCreditsValue" class="text-success fw-bold">--</span> lượt
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="profile-info-item">
                                    <div class="profile-info-label">
                                        <i class="bi bi-calendar-check"></i>Hạn sử dụng
                                    </div>
                                    <div class="profile-info-value">
                                        <span id="expiryDateValue">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="profile-info-item">
                                    <div class="profile-info-label">
                                        <i class="bi bi-star"></i>Gói hiện tại
                                    </div>
                                    <div class="profile-info-value">
                                        <span class="badge bg-info" id="currentPlanValue">FREE</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <a href="/html/plans.html" class="btn btn-primary">
                                <i class="bi bi-cart-plus me-1"></i>Nâng cấp gói
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Account Information Card -->
                <div class="col-12">
                    <div class="profile-card">
                        <h5 class="profile-card-title">
                            <i class="bi bi-person-badge"></i>
                            Thông tin tài khoản
                        </h5>
                        
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="profile-info-item">
                                    <div class="profile-info-label">
                                        <i class="bi bi-person"></i>Họ và tên
                                    </div>
                                    <div class="profile-info-value" id="infoFullName">Đang tải...</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="profile-info-item">
                                    <div class="profile-info-label">
                                        <i class="bi bi-envelope"></i>Email
                                    </div>
                                    <div class="profile-info-value" id="infoEmail">email@example.com</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="profile-info-item">
                                    <div class="profile-info-label">
                                        <i class="bi bi-shield-check"></i>Vai trò
                                    </div>
                                    <div class="profile-info-value">
                                        <span class="badge bg-primary" id="infoRole">USER</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Change Password Card -->
                <div class="col-12">
                    <div class="profile-card">
                        <h5 class="profile-card-title">
                            <i class="bi bi-shield-lock"></i>
                            Đổi mật khẩu
                        </h5>
                        
                        <form id="changePasswordForm">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">
                                    <i class="bi bi-key me-1"></i>Mật khẩu hiện tại
                                </label>
                                <input type="password" class="form-control" id="currentPassword" required 
                                       placeholder="Nhập mật khẩu hiện tại">
                                <div class="invalid-feedback d-block" id="currentPasswordError"></div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newPassword" class="form-label">
                                        <i class="bi bi-lock me-1"></i>Mật khẩu mới
                                    </label>
                                    <input type="password" class="form-control" id="newPassword" required 
                                           placeholder="Tối thiểu 6 ký tự">
                                    <div class="invalid-feedback d-block" id="newPasswordError"></div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="confirmNewPassword" class="form-label">
                                        <i class="bi bi-lock-fill me-1"></i>Xác nhận mật khẩu
                                    </label>
                                    <input type="password" class="form-control" id="confirmNewPassword" required 
                                           placeholder="Nhập lại mật khẩu mới">
                                    <div class="invalid-feedback d-block" id="confirmNewPasswordError"></div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>Cập nhật mật khẩu
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JS -->
<script src="/scripts/toast-notification.js"></script>
<script src="/scripts/script.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('accessToken');
    if (!token) {
        window.location.href = '/html/login.html';
        return;
    }

    // Load user profile
    loadUserProfile();

    // Avatar upload handler
    document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);

    // Change password form handler
    document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);

    // Real-time validation for password fields
    setupPasswordValidation();
});

async function loadUserProfile() {
    try {
        const res = await fetch('/api/auth/me', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            }
        });

        if (!res.ok) {
            throw new Error('Không thể tải thông tin người dùng');
        }

        const user = await res.json();
        
        // Update UI
        document.getElementById('profileFullName').textContent = user.fullName || 'Người dùng';
        document.getElementById('profileEmail').textContent = user.email || '';
        document.getElementById('infoFullName').textContent = user.fullName || 'Người dùng';
        document.getElementById('infoEmail').textContent = user.email || '';
        document.getElementById('infoRole').textContent = user.role || 'USER';
        
        // Update avatar if exists
        if (user.avatarUrl) {
            document.getElementById('profileAvatar').src = user.avatarUrl;
        }
        
        // Load credits information
        loadCreditsInfo();
    } catch (err) {
        console.error('Error loading profile:', err);
        showError('currentPasswordError', 'Không thể tải thông tin hồ sơ');
    }
}

async function loadCreditsInfo() {
    try {
        const res = await fetch('/api/credits/balance', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            }
        });

        if (!res.ok) {
            throw new Error('Không thể tải thông tin credits');
        }

        const credits = await res.json();
        
        // Update credits UI
        document.getElementById('chatCreditsValue').textContent = credits.chatCredits || 0;
        document.getElementById('quizGenCreditsValue').textContent = credits.quizGenCredits || 0;
        
        // Format expiry date
        if (credits.expiryDate) {
            const expiryDate = new Date(credits.expiryDate);
            const formattedDate = expiryDate.toLocaleDateString('vi-VN');
            document.getElementById('expiryDateValue').textContent = formattedDate;
            
            // Check if expired
            if (credits.isExpired) {
                document.getElementById('expiryDateValue').innerHTML = 
                    `<span class="text-danger">${formattedDate} (Đã hết hạn)</span>`;
            }
        } else {
            document.getElementById('expiryDateValue').textContent = 'Vĩnh viễn';
        }
        
        // Update plan badge
        const planBadge = document.getElementById('currentPlanValue');
        if (credits.planName) {
            planBadge.textContent = credits.planName;
            
            // Set badge color based on plan
            planBadge.className = 'badge';
            if (credits.planName === 'FREE') {
                planBadge.classList.add('bg-secondary');
            } else if (credits.planName === 'REGULAR') {
                planBadge.classList.add('bg-primary');
            } else if (credits.planName === 'STUDENT') {
                planBadge.classList.add('bg-success');
            } else {
                planBadge.classList.add('bg-info');
            }
        }
    } catch (err) {
        console.error('Error loading credits:', err);
        // Don't show error to user, just log it
    }
}

async function handleAvatarUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    // Validate file size (5MB)
    if (file.size > 5 * 1024 * 1024) {
        Toast.warning('Kích thước ảnh không được vượt quá 5MB');
        return;
    }

    // Validate file type
    if (!file.type.startsWith('image/')) {
        Toast.warning('Vui lòng chọn file ảnh (JPG, PNG, GIF)');
        return;
    }

    // Preview image immediately
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('profileAvatar').src = e.target.result;
    };
    reader.readAsDataURL(file);

    // Upload to server
    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const res = await fetch('/api/user/avatar', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            },
            body: formData
        });

        if (!res.ok) {
            throw new Error('Không thể tải ảnh lên');
        }

        Toast.success('Cập nhật ảnh đại diện thành công');
    } catch (err) {
        console.error('Error uploading avatar:', err);
        Toast.error('Có lỗi xảy ra khi tải ảnh lên. Vui lòng thử lại');
        // Reload original avatar
        loadUserProfile();
    }
}

function setupPasswordValidation() {
    const currentPassword = document.getElementById('currentPassword');
    const newPassword = document.getElementById('newPassword');
    const confirmNewPassword = document.getElementById('confirmNewPassword');

    currentPassword.addEventListener('input', () => {
        if (currentPassword.value) clearError('currentPasswordError');
    });

    newPassword.addEventListener('blur', () => {
        const value = newPassword.value;
        if (!value) {
            showError('newPasswordError', 'Vui lòng nhập mật khẩu mới');
        } else if (value.length < 6) {
            showError('newPasswordError', 'Mật khẩu phải có ít nhất 6 ký tự');
        } else {
            clearError('newPasswordError');
        }
        // Re-validate confirm if it has value
        if (confirmNewPassword.value) {
            validateConfirmNewPassword();
        }
    });

    newPassword.addEventListener('input', () => {
        if (newPassword.value) {
            clearError('newPasswordError');
        }
        if (confirmNewPassword.value) {
            validateConfirmNewPassword();
        }
    });

    confirmNewPassword.addEventListener('blur', validateConfirmNewPassword);
    confirmNewPassword.addEventListener('input', () => {
        if (confirmNewPassword.value) {
            validateConfirmNewPassword();
        }
    });
}

function validateConfirmNewPassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmNewPassword').value;
    
    if (!confirm) {
        showError('confirmNewPasswordError', 'Vui lòng xác nhận mật khẩu mới');
        return false;
    } else if (newPassword !== confirm) {
        showError('confirmNewPasswordError', 'Mật khẩu xác nhận không khớp');
        return false;
    } else {
        clearError('confirmNewPasswordError');
        return true;
    }
}

async function handleChangePassword(e) {
    e.preventDefault();

    // Clear all errors
    clearError('currentPasswordError');
    clearError('newPasswordError');
    clearError('confirmNewPasswordError');

    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;

    let hasError = false;

    // Validate
    if (!currentPassword) {
        showError('currentPasswordError', 'Vui lòng nhập mật khẩu hiện tại');
        hasError = true;
    }

    if (!newPassword) {
        showError('newPasswordError', 'Vui lòng nhập mật khẩu mới');
        hasError = true;
    } else if (newPassword.length < 6) {
        showError('newPasswordError', 'Mật khẩu phải có ít nhất 6 ký tự');
        hasError = true;
    }

    if (!confirmNewPassword) {
        showError('confirmNewPasswordError', 'Vui lòng xác nhận mật khẩu mới');
        hasError = true;
    } else if (newPassword !== confirmNewPassword) {
        showError('confirmNewPasswordError', 'Mật khẩu xác nhận không khớp');
        hasError = true;
    }

    if (hasError) return;

    try {
        const res = await fetch('/api/user/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            },
            body: JSON.stringify({
                currentPassword,
                newPassword
            })
        });

        if (!res.ok) {
            const text = await res.text();
            let errorMessage = 'Đổi mật khẩu thất bại';
            
            try {
                const data = JSON.parse(text);
                errorMessage = data.error || data.message || errorMessage;
            } catch (e) {
                errorMessage = text || errorMessage;
            }
            
            showError('currentPasswordError', errorMessage);
            return;
        }

        // Success
        Toast.success('Đổi mật khẩu thành công!');
        document.getElementById('changePasswordForm').reset();
        clearError('currentPasswordError');
        clearError('newPasswordError');
        clearError('confirmNewPasswordError');
    } catch (err) {
        console.error('Error changing password:', err);
        showError('currentPasswordError', 'Có lỗi xảy ra, vui lòng thử lại');
    }
}

function clearError(errorId) {
    const errorDiv = document.getElementById(errorId);
    const input = document.getElementById(errorId.replace('Error', ''));
    if (input) input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
}

function showError(errorId, message) {
    const errorDiv = document.getElementById(errorId);
    const input = document.getElementById(errorId.replace('Error', ''));
    if (input) input.classList.add('is-invalid');
    if (errorDiv) errorDiv.textContent = message;
}
</script>
</body>
</html>
