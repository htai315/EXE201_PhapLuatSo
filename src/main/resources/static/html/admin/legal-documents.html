<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Văn Bản Pháp Luật - Admin Panel</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/toast-notification.css">
    <link rel="stylesheet" href="/css/confirm-modal.css">

    <style>
        /* Page specific styles */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--admin-dark);
        }

        /* Mini Stats */
        .mini-stats {
            display: flex;
            gap: 1rem;
        }

        .mini-stat {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--admin-shadow-sm);
        }

        .mini-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .mini-stat-icon.blue {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .mini-stat-icon.green {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .mini-stat-info {
            line-height: 1.2;
        }

        .mini-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--admin-dark);
        }

        .mini-stat-label {
            font-size: 0.75rem;
            color: var(--admin-gray);
        }

        /* Upload Section - Compact */
        .upload-section {
            background: white;
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--admin-shadow-sm);
        }

        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .upload-header h6 {
            margin: 0;
            font-weight: 600;
            color: var(--admin-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--admin-primary);
            background: #eff6ff;
        }

        .upload-zone i {
            font-size: 2rem;
            color: var(--admin-primary);
            margin-bottom: 0.5rem;
        }

        .upload-zone h6 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--admin-dark);
        }

        .upload-zone p {
            margin: 0.25rem 0 0;
            font-size: 0.8rem;
            color: var(--admin-gray);
        }

        .file-list {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .file-item .bi-file-pdf {
            color: #ef4444;
        }

        /* Documents Section */
        .documents-section {
            background: white;
            border-radius: 16px;
            box-shadow: var(--admin-shadow-sm);
            overflow: hidden;
        }

        .documents-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .documents-header h6 {
            margin: 0;
            font-weight: 600;
            color: var(--admin-dark);
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f1f5f9;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            min-width: 250px;
        }

        .search-box i {
            color: var(--admin-gray);
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            flex: 1;
            font-size: 0.875rem;
        }

        /* Document Cards */
        .documents-grid {
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }

        .doc-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }

        .doc-card:hover {
            border-color: var(--admin-primary);
            box-shadow: 0 4px 12px rgba(26, 75, 132, 0.1);
        }

        .doc-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .doc-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .doc-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .doc-title {
            font-weight: 600;
            color: var(--admin-dark);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .doc-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--admin-gray);
        }

        .doc-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .doc-meta .badge {
            font-weight: 500;
            padding: 0.25rem 0.5rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--admin-gray);
        }

        .empty-state i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        /* Pagination */
        .pagination-wrapper {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            border-color: var(--admin-primary);
            color: var(--admin-primary);
        }

        .page-btn.active {
            background: var(--admin-primary);
            color: white;
            border-color: var(--admin-primary);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .mini-stats {
                flex-wrap: wrap;
            }

            .documents-grid {
                grid-template-columns: 1fr;
            }

            .search-box {
                min-width: 100%;
            }
        }
    </style>
</head>

<body class="admin-body" data-auth-required="true" data-admin-required="true">

    <!-- Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
        <div class="admin-sidebar-header">
            <h4><i class="bi bi-shield-lock-fill"></i> Admin Panel</h4>
            <button class="btn-close-sidebar" id="closeSidebar"><i class="bi bi-x-lg"></i></button>
        </div>
        <nav class="admin-nav">
            <div class="admin-nav-item">
                <a href="/html/admin/dashboard.html" class="admin-nav-link">
                    <i class="bi bi-speedometer2"></i><span>Dashboard</span>
                </a>
            </div>
            <div class="admin-nav-item">
                <a href="/html/admin/users.html" class="admin-nav-link">
                    <i class="bi bi-people"></i><span>Quản Lý Users</span>
                </a>
            </div>
            <div class="admin-nav-item">
                <a href="/html/admin/payments.html" class="admin-nav-link">
                    <i class="bi bi-credit-card"></i><span>Quản Lý Payments</span>
                </a>
            </div>
            <div class="admin-nav-item">
                <a href="/html/admin/activity-logs.html" class="admin-nav-link">
                    <i class="bi bi-clock-history"></i><span>Activity Logs</span>
                </a>
            </div>
            <div class="admin-nav-item">
                <a href="/html/admin/legal-documents.html" class="admin-nav-link active">
                    <i class="bi bi-file-earmark-text"></i><span>Văn Bản Pháp Luật</span>
                </a>
            </div>
            <div class="admin-nav-item">
                <a href="/html/admin/embeddings.html" class="admin-nav-link">
                    <i class="bi bi-cpu"></i><span>Vector Embeddings</span>
                </a>
            </div>
            <div class="admin-nav-item">
                <a href="/index.html" class="admin-nav-link">
                    <i class="bi bi-house"></i><span>Về Trang Chủ</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Topbar -->
        <div class="admin-topbar">
            <div class="admin-topbar-left">
                <button class="btn-toggle-sidebar" id="toggleSidebar"><i class="bi bi-list"></i></button>
                <h1 class="admin-topbar-title"><i class="bi bi-file-earmark-text me-2"></i>Văn Bản Pháp Luật</h1>
            </div>
            <div class="admin-topbar-right">
                <div class="admin-user-info">
                    <div class="admin-user-avatar"><i class="bi bi-person-fill"></i></div>
                    <span class="admin-user-name" id="adminUserName">Admin</span>
                </div>
                <button class="btn-logout" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Đăng Xuất</button>
            </div>
        </div>

        <!-- Content -->
        <div class="admin-content">
            <!-- Page Header with Mini Stats -->
            <div class="page-header">
                <h2>Quản Lý Văn Bản</h2>
                <div class="mini-stats">
                    <div class="mini-stat">
                        <div class="mini-stat-icon blue"><i class="bi bi-file-earmark-text"></i></div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="totalDocuments">0</div>
                            <div class="mini-stat-label">Văn bản</div>
                        </div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-icon green"><i class="bi bi-list-ol"></i></div>
                        <div class="mini-stat-info">
                            <div class="mini-stat-value" id="totalArticles">0</div>
                            <div class="mini-stat-label">Điều luật</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Section - Compact -->
            <div class="upload-section">
                <div class="upload-header">
                    <h6><i class="bi bi-cloud-upload"></i> Upload Văn Bản</h6>
                    <button class="btn btn-sm btn-primary" id="uploadBtn" style="display:none;">
                        <i class="bi bi-upload me-1"></i>Upload
                    </button>
                </div>
                <div class="upload-zone" id="uploadZone">
                    <i class="bi bi-file-earmark-arrow-up"></i>
                    <h6>Kéo thả file PDF vào đây hoặc click để chọn</h6>
                    <p>Hỗ trợ: PDF (Tối đa 10MB/file)</p>
                    <input type="file" id="fileInput" accept=".pdf" multiple hidden>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <!-- Documents Section -->
            <div class="documents-section">
                <div class="documents-header">
                    <h6><i class="bi bi-folder2-open me-2"></i>Danh Sách Văn Bản</h6>
                    <div class="d-flex gap-2 align-items-center">
                        <div class="search-box">
                            <i class="bi bi-search"></i>
                            <input type="text" id="searchInput" placeholder="Tìm theo tên hoặc mã...">
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadDocuments()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="documents-grid" id="documentsList"></div>
                <div class="pagination-wrapper" id="paginationContainer"></div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 mb-0">Đang xử lý...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/scripts/token-manager.js"></script>
    <script src="/scripts/auth-guard.js"></script>
    <script src="/scripts/toast-notification.js"></script>
    <script src="/scripts/api-client.js"></script>
    <script src="/scripts/app-runtime.js"></script>
    <script src="/scripts/confirm-modal.js"></script>

    <script>
        // State
        let currentPage = 0;
        let pageSize = 6;
        let totalPages = 0;
        let searchQuery = '';
        let selectedFiles = [];

        // DOM Elements
        const sidebar = document.getElementById('adminSidebar');
        const toggleBtn = document.getElementById('toggleSidebar');
        const closeBtn = document.getElementById('closeSidebar');
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');
        const searchInput = document.getElementById('searchInput');
        const documentsList = document.getElementById('documentsList');
        const paginationContainer = document.getElementById('paginationContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Use AUTH.guard() for proper rehydration
            const isAuthorized = await AUTH.guard({
                requireAuth: true,
                requireAdmin: true,
                redirect: false
            });

            if (!isAuthorized) {
                if (!AUTH.isLoggedIn()) {
                    window.location.href = '/html/login.html';
                } else {
                    Toast.error('Bạn không có quyền truy cập trang này');
                    setTimeout(() => window.location.href = '/index.html', 1500);
                }
                return;
            }

            try {
                // Standardized client access + auth bootstrap
                try { await AppRuntime.authReady(); } catch (e) { /* ignore */ }
                const client = AppRuntime.requireClient('AdminLegal');
                const user = await AppRuntime.safe('AdminLegal:getMe', () => AppRuntime.getMe(client));
                document.getElementById('adminUserName').textContent = user.fullName || 'Admin';

                // Setup sidebar
                setupSidebar();

                // Setup upload
                setupUpload();

                // Setup search
                setupSearch();

                // Load data
                loadStats();
                loadDocuments();
            } catch (error) {
                console.error('Failed to load user info:', error);
                Toast.error('Không thể tải thông tin user');
            }
        });

        // Sidebar toggle
        function setupSidebar() {
            toggleBtn.addEventListener('click', () => sidebar.classList.add('show'));
            closeBtn.addEventListener('click', () => sidebar.classList.remove('show'));
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 992 && !sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            });
        }

        // Upload functionality
        function setupUpload() {
            // Click to select
            uploadZone.addEventListener('click', () => fileInput.click());

            // Drag & drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // File input change
            fileInput.addEventListener('change', () => {
                handleFiles(fileInput.files);
            });

            // Upload button
            uploadBtn.addEventListener('click', uploadFiles);
        }

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(f => {
                if (f.type !== 'application/pdf') {
                    Toast.warning(`${f.name} không phải file PDF`);
                    return false;
                }
                if (f.size > 10 * 1024 * 1024) {
                    Toast.warning(`${f.name} vượt quá 10MB`);
                    return false;
                }
                return true;
            });

            selectedFiles = [...selectedFiles, ...validFiles];
            renderFileList();
        }

        function renderFileList() {
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '';
                uploadBtn.style.display = 'none';
                return;
            }

            uploadBtn.style.display = 'inline-flex';
            fileList.innerHTML = selectedFiles.map((f, i) => `
        <div class="file-item">
            <i class="bi bi-file-pdf"></i>
            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${f.name}</span>
            <span class="text-muted">${formatFileSize(f.size)}</span>
            <button class="btn btn-sm btn-link text-danger p-0" onclick="removeFile(${i})">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFileList();
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            showLoading(true);
            let successCount = 0;
            let failCount = 0;

            for (const file of selectedFiles) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('documentName', file.name.replace('.pdf', ''));

                    try { await AppRuntime.authReady(); } catch (e) { /* ignore */ }
                    const client = AppRuntime.getClient();
                    if (!client) {
                        console.warn('[Admin Legal] API client not available; upload skipped');
                        failCount++;
                        continue;
                    }
                    const response = await client.fetchWithAuth('/api/legal/documents/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                        const err = await response.json().catch(() => ({}));
                        console.error(`Upload failed for ${file.name}:`, err);
                    }
                } catch (error) {
                    failCount++;
                    console.error(`Upload error for ${file.name}:`, error);
                }
            }

            showLoading(false);
            selectedFiles = [];
            renderFileList();
            fileInput.value = '';

            if (successCount > 0) {
                Toast.success(`Upload thành công ${successCount} file`);
                loadStats();
                loadDocuments();
            }
            if (failCount > 0) {
                Toast.error(`Upload thất bại ${failCount} file`);
            }
        }

        // Search with debounce
        function setupSearch() {
            let timeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    searchQuery = searchInput.value.trim();
                    currentPage = 0;
                    loadDocuments();
                }, 300);
            });
        }

        // Load stats
        async function loadStats() {
            try {
                try { await AppRuntime.authReady(); } catch (e) { /* ignore */ }
                const client = AppRuntime.getClient();
                if (!client) {
                    console.warn('[Admin Legal] API client not available; cannot load stats');
                    return;
                }
                const stats = await AppRuntime.safe('AdminLegal:stats', () => client.get('/api/legal/documents/stats'));
                document.getElementById('totalDocuments').textContent = stats.totalDocuments || 0;
                document.getElementById('totalArticles').textContent = stats.totalArticles || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load documents
        async function loadDocuments() {
            try {
                let url = `/api/legal/documents/paginated?page=${currentPage}&size=${pageSize}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                try { await AppRuntime.authReady(); } catch (e) { /* ignore */ }
                const client = AppRuntime.getClient();
                if (!client) {
                    console.warn('[Admin Legal] API client not available; cannot load documents');
                    documentsList.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><i class="bi bi-exclamation-circle"></i><p>Hệ thống tạm thời không khả dụng</p></div>`;
                    return;
                }
                const data = await AppRuntime.safe('AdminLegal:loadDocuments', () => client.get(url));
                totalPages = data.totalPages || 0;
                displayDocuments(data.documents || []);
                displayPagination();
            } catch (error) {
                console.error('Error loading documents:', error);
                documentsList.innerHTML = `
            <div class="empty-state" style="grid-column:1/-1;">
                <i class="bi bi-exclamation-circle"></i>
                <p>Không thể tải danh sách văn bản</p>
            </div>
        `;
            }
        }

        function displayDocuments(documents) {
            if (documents.length === 0) {
                documentsList.innerHTML = `
            <div class="empty-state" style="grid-column:1/-1;">
                <i class="bi bi-folder2-open"></i>
                <p>Chưa có văn bản nào</p>
            </div>
        `;
                return;
            }

            documentsList.innerHTML = documents.map(doc => `
        <div class="doc-card">
            <div class="doc-card-header">
                <div class="doc-icon"><i class="bi bi-file-earmark-text"></i></div>
                <div class="doc-actions">
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteDocument(${doc.id}, '${escapeHtml(doc.documentName)}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="doc-title" title="${escapeHtml(doc.documentName)}">${escapeHtml(doc.documentName)}</div>
            <div class="doc-meta">
                <span><i class="bi bi-hash"></i>${doc.documentCode || 'N/A'}</span>
                <span><i class="bi bi-list-ol"></i>${doc.totalArticles || 0} điều</span>
                <span><i class="bi bi-calendar3"></i>${formatDate(doc.createdAt)}</span>
            </div>
        </div>
    `).join('');
        }

        function displayPagination() {
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let html = '';

            // Prev button
            html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>
        <i class="bi bi-chevron-left"></i>
    </button>`;

            // Page numbers
            const maxVisible = 5;
            let start = Math.max(0, currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalPages, start + maxVisible);

            if (end - start < maxVisible) {
                start = Math.max(0, end - maxVisible);
            }

            if (start > 0) {
                html += `<button class="page-btn" onclick="goToPage(0)">1</button>`;
                if (start > 1) html += `<span style="padding:0 0.5rem;">...</span>`;
            }

            for (let i = start; i < end; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i + 1}</button>`;
            }

            if (end < totalPages) {
                if (end < totalPages - 1) html += `<span style="padding:0 0.5rem;">...</span>`;
                html += `<button class="page-btn" onclick="goToPage(${totalPages - 1})">${totalPages}</button>`;
            }

            // Next button
            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>
        <i class="bi bi-chevron-right"></i>
    </button>`;

            paginationContainer.innerHTML = html;
        }

        function goToPage(page) {
            if (page < 0 || page >= totalPages) return;
            currentPage = page;
            loadDocuments();
        }

        // Delete document
        async function deleteDocument(id, title) {
            const confirmed = await window.ConfirmModal.show({
                title: 'Xác nhận xóa',
                message: `Bạn có chắc muốn xóa văn bản "${title}"?`,
                confirmText: 'Xóa',
                cancelText: 'Hủy',
                type: 'danger'
            });

            if (!confirmed) return;

            showLoading(true);
            try {
                try { await AppRuntime.authReady(); } catch (e) { /* ignore */ }
                const client = AppRuntime.getClient();
                if (!client) throw new Error('API client missing');
                await client.delete(`/api/legal/documents/${id}`);
                Toast.success('Đã xóa văn bản');
                loadStats();
                loadDocuments();
            } catch (error) {
                Toast.error(error.error || 'Không thể xóa văn bản');
            } finally {
                showLoading(false);
            }
        }

        // Utilities
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN');
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function showLoading(show) {
            loadingOverlay.classList.toggle('show', show);
        }

        function logout() {
            AUTH.clearAuth();
            window.location.href = '/html/login.html';
        }
    </script>

</body>

</html>