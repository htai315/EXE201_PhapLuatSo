<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả Thanh Toán - Pháp Luật Số</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/img/Law.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/payment-result.css">
</head>
<body>

<div class="result-container">
    <div class="result-card" id="resultCard">
        <!-- Loading state -->
        <div id="loadingState">
            <div class="loading-spinner"></div>
            <h2 class="result-title mt-4">Đang xử lý...</h2>
            <p class="result-message">Vui lòng đợi trong giây lát</p>
        </div>

        <!-- Success state -->
        <div id="successState" style="display: none;">
            <div class="result-icon success">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <h1 class="result-title success">Thanh Toán Thành Công!</h1>
            <p class="result-message">
                Cảm ơn bạn đã tin tưởng sử dụng dịch vụ của chúng tôi.<br>
                Credits đã được cộng vào tài khoản của bạn.
            </p>
            
            <div class="credits-badge">
                <i class="bi bi-coin"></i>
                <span id="creditsInfo">Loading...</span>
            </div>
            
            <div class="result-details" id="paymentDetails">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <button class="btn btn-home" onclick="goHome()">
                <i class="bi bi-house-door me-2"></i>Về Trang Chủ
            </button>
            
            <div class="redirect-timer" id="redirectTimer">
                Tự động chuyển về trang chủ sau <span id="countdown">5</span> giây...
            </div>
        </div>

        <!-- Failed state -->
        <div id="failedState" style="display: none;">
            <div class="result-icon failed">
                <i class="bi bi-x-circle-fill"></i>
            </div>
            <h1 class="result-title failed">Thanh Toán Thất Bại</h1>
            <p class="result-message" id="failedMessage">
                Rất tiếc, giao dịch của bạn không thành công.<br>
                Vui lòng thử lại hoặc liên hệ hỗ trợ.
            </p>
            
            <div class="result-details" id="failedDetails">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="d-flex gap-3 justify-content-center">
                <button class="btn btn-retry" onclick="retryPayment()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Thử Lại
                </button>
                <button class="btn btn-home" onclick="goHome()">
                    <i class="bi bi-house-door me-2"></i>Về Trang Chủ
                </button>
            </div>
        </div>

        <!-- Pending state -->
        <div id="pendingState" style="display: none;">
            <div class="result-icon pending">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <h1 class="result-title pending">Đang Chờ Thanh Toán</h1>
            <p class="result-message">
                Giao dịch của bạn đang được xử lý.<br>
                Vui lòng hoàn tất thanh toán hoặc đợi trong giây lát.
            </p>
            
            <div class="d-flex gap-3 justify-content-center mt-4">
                <button class="btn btn-primary" onclick="checkStatus()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Kiểm tra lại
                </button>
                <button class="btn btn-home" onclick="goHome()">
                    <i class="bi bi-house-door me-2"></i>Về Trang Chủ
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Get URL parameters
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        orderCode: params.get('orderCode'),
        status: params.get('status'),
        code: params.get('code') // PayOS response code
    };
}

// Format amount
function formatAmount(amount) {
    if (!amount) return '0';
    return parseInt(amount).toLocaleString('vi-VN') + ' VNĐ';
}

// Fetch credit balance
async function fetchCreditBalance() {
    try {
        const token = localStorage.getItem('accessToken');
        if (!token) return null;
        
        const response = await fetch('/api/credits/balance', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('Error fetching credits:', error);
    }
    return null;
}

// Check payment status from backend
async function checkPaymentStatus(orderCode) {
    try {
        const response = await fetch(`/api/payment/status/${orderCode}`);
        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('Error checking payment status:', error);
    }
    return null;
}

// Show success state
async function showSuccess(paymentData) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('successState').style.display = 'block';
    
    // Fetch and display credits
    const credits = await fetchCreditBalance();
    if (credits) {
        let creditsText = `${credits.chatCredits} Chat`;
        if (credits.quizGenCredits > 0) {
            creditsText += ` + ${credits.quizGenCredits} Quiz`;
        }
        document.getElementById('creditsInfo').textContent = creditsText;
    }
    
    // Display payment details
    const detailsHtml = `
        <div class="detail-row">
            <span class="detail-label">Mã đơn hàng:</span>
            <span class="detail-value">${paymentData.orderCode || 'N/A'}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Số tiền:</span>
            <span class="detail-value">${formatAmount(paymentData.amount)}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Gói:</span>
            <span class="detail-value">${paymentData.planCode || 'N/A'}</span>
        </div>
        ${paymentData.chatCredits ? `
        <div class="detail-row">
            <span class="detail-label">Chat Credits:</span>
            <span class="detail-value">+${paymentData.chatCredits}</span>
        </div>
        ` : ''}
        ${paymentData.quizCredits ? `
        <div class="detail-row">
            <span class="detail-label">Quiz Credits:</span>
            <span class="detail-value">+${paymentData.quizCredits}</span>
        </div>
        ` : ''}
    `;
    document.getElementById('paymentDetails').innerHTML = detailsHtml;
    
    // Start countdown
    startCountdown();
}

// Show failed state
function showFailed(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('failedState').style.display = 'block';
    
    if (message) {
        document.getElementById('failedMessage').innerHTML = 
            `Rất tiếc, giao dịch của bạn không thành công.<br><strong>Lý do:</strong> ${message}`;
    }
}

// Show pending state
function showPending() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('pendingState').style.display = 'block';
}

// Countdown timer
function startCountdown() {
    let seconds = 5;
    const countdownEl = document.getElementById('countdown');
    
    const interval = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        
        if (seconds <= 0) {
            clearInterval(interval);
            goHome();
        }
    }, 1000);
}

// Navigation functions
function goHome() {
    window.location.href = '/index.html';
}

function retryPayment() {
    window.location.href = '/html/plans.html';
}

// Check status button handler
async function checkStatus() {
    const params = getUrlParams();
    if (params.orderCode) {
        document.getElementById('pendingState').style.display = 'none';
        document.getElementById('loadingState').style.display = 'block';
        await processPayment();
    }
}

// Main processing function
async function processPayment() {
    const params = getUrlParams();
    
    console.log('Payment result params:', params);
    
    if (!params.orderCode) {
        showFailed('Không tìm thấy mã đơn hàng');
        return;
    }
    
    // Check payment status from backend
    const paymentData = await checkPaymentStatus(params.orderCode);
    
    if (!paymentData) {
        showFailed('Không thể kiểm tra trạng thái thanh toán');
        return;
    }
    
    console.log('Payment data:', paymentData);
    
    if (paymentData.status === 'SUCCESS') {
        await showSuccess(paymentData);
    } else if (paymentData.status === 'FAILED') {
        showFailed('Thanh toán không thành công');
    } else {
        // Still pending - show pending state
        showPending();
    }
}

// Main execution
window.addEventListener('DOMContentLoaded', async () => {
    console.log('Payment result page loaded');
    await processPayment();
});
</script>

</body>
</html>
