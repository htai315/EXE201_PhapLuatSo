<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả Thanh Toán - Pháp Luật Số</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/img/Law.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/payment-result.css">
</head>
<body>

<div class="result-container">
    <div class="result-card" id="resultCard">
        <!-- Loading state -->
        <div id="loadingState">
            <div class="loading-spinner"></div>
            <h2 class="result-title mt-4">Đang xử lý...</h2>
            <p class="result-message">Vui lòng đợi trong giây lát</p>
        </div>

        <!-- Success state -->
        <div id="successState" style="display: none;">
            <div class="result-icon success">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <h1 class="result-title success">Thanh Toán Thành Công!</h1>
            <p class="result-message">
                Cảm ơn bạn đã tin tưởng sử dụng dịch vụ của chúng tôi.<br>
                Credits đã được cộng vào tài khoản của bạn.
            </p>
            
            <div class="credits-badge">
                <i class="bi bi-coin"></i>
                <span id="creditsInfo">Loading...</span>
            </div>
            
            <div class="result-details" id="paymentDetails">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <button class="btn btn-home" onclick="goHome()">
                <i class="bi bi-house-door me-2"></i>Về Trang Chủ
            </button>
            
            <div class="redirect-timer" id="redirectTimer">
                Tự động chuyển về trang chủ sau <span id="countdown">5</span> giây...
            </div>
        </div>

        <!-- Failed state -->
        <div id="failedState" style="display: none;">
            <div class="result-icon failed">
                <i class="bi bi-x-circle-fill"></i>
            </div>
            <h1 class="result-title failed">Thanh Toán Thất Bại</h1>
            <p class="result-message" id="failedMessage">
                Rất tiếc, giao dịch của bạn không thành công.<br>
                Vui lòng thử lại hoặc liên hệ hỗ trợ.
            </p>
            
            <div class="result-details" id="failedDetails">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="d-flex gap-3 justify-content-center">
                <button class="btn btn-retry" onclick="retryPayment()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Thử Lại
                </button>
                <button class="btn btn-home" onclick="goHome()">
                    <i class="bi bi-house-door me-2"></i>Về Trang Chủ
                </button>
            </div>
        </div>

        <!-- Pending state -->
        <div id="pendingState" style="display: none;">
            <div class="result-icon pending">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <h1 class="result-title pending">Đang Chờ Thanh Toán</h1>
            <p class="result-message">
                Giao dịch của bạn đang được xử lý.<br>
                Vui lòng hoàn tất thanh toán hoặc đợi trong giây lát.
            </p>
            
            <div class="d-flex gap-3 justify-content-center mt-4">
                <button class="btn btn-primary" onclick="checkStatus()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Kiểm tra lại
                </button>
                <button class="btn btn-home" onclick="goHome()">
                    <i class="bi bi-house-door me-2"></i>Về Trang Chủ
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===== PAYMENT STATUS HELPER FUNCTIONS =====
// Backend state machine: PENDING → PAID → CREDITED (final success)
// Legacy SUCCESS is migrated to CREDITED

/**
 * Check if payment status indicates successful completion (credits added)
 * @param {string} status - Payment status from backend
 * @returns {boolean} - True if payment is successfully completed
 */
function isPaymentSuccess(status) {
    return status === 'CREDITED' || status === 'SUCCESS'; // Backward compatibility
}

/**
 * Check if payment status indicates final state (stop polling)
 * @param {string} status - Payment status from backend
 * @returns {boolean} - True if polling should stop
 */
function isPaymentFinalStatus(status) {
    return ['CREDITED', 'SUCCESS', 'FAILED', 'CANCELLED', 'EXPIRED', 'PAID_CREDIT_FAILED', 'NEEDS_REVIEW'].includes(status);
}

/**
 * Check if payment status indicates money was received but credits failed to add
 * @param {string} status - Payment status from backend
 * @returns {boolean} - True if money received but credit addition failed
 */
function isPaymentCreditFailed(status) {
    return ['PAID_CREDIT_FAILED', 'NEEDS_REVIEW'].includes(status);
}

// Get URL parameters
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        orderCode: params.get('orderCode'),
        status: params.get('status'),
        code: params.get('code'), // PayOS response code
        token: params.get('token') // Status token for polling
    };
}

// Format amount
function formatAmount(amount) {
    if (!amount) return '0';
    return parseInt(amount).toLocaleString('vi-VN') + ' VNĐ';
}

// Fetch credit balance
async function fetchCreditBalance() {
    try {
        // Direct fetch with credentials - no apiClient dependency for production safety
        const response = await fetch('/api/credits/balance', { credentials: 'include' });
        if (response.ok) {
            return await response.json();
        }
        // 401/403/404 expected in redirect scenarios - return null gracefully
    } catch (error) {
        console.error('Error fetching credits:', error.message);
        // Network errors, CORS issues, etc. - return null gracefully
    }
    return null;
}

// Check payment status from backend
async function checkPaymentStatus(orderCode, token) {
    try {
        // Include status token for unauthenticated polling (only if token exists)
        const tokenParam = token ? `?token=${encodeURIComponent(token)}` : '';
        const response = await fetch(`/api/payment/status/${orderCode}${tokenParam}`);

        if (response.status === 404) {
            // Token expired, invalid, or missing - provide user-friendly message
            throw new Error('Phiên kiểm tra trạng thái thanh toán đã hết hạn hoặc không hợp lệ. Vui lòng kiểm tra lịch sử thanh toán hoặc tạo thanh toán mới.');
        }

        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('Error checking payment status:', error.message);
        throw error; // Re-throw to preserve specific error messages
    }
    return null;
}

// Show success state
async function showSuccess(paymentData) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('successState').style.display = 'block';
    
    // Display purchased credits immediately (always available on success)
    let creditsText = '';
    if (paymentData.chatCredits || paymentData.quizCredits) {
        creditsText = `+${paymentData.chatCredits || 0} Chat`;
        if (paymentData.quizCredits > 0) {
            creditsText += ` +${paymentData.quizCredits} Quiz`;
        }
    } else {
        creditsText = 'Credits đã được cộng';
    }
    document.getElementById('creditsInfo').textContent = creditsText;

    // Optionally fetch and display current balance (may fail in redirect scenarios)
    try {
        const currentCredits = await fetchCreditBalance();
        if (currentCredits) {
            let balanceText = `${currentCredits.chatCredits} Chat`;
            if (currentCredits.quizGenCredits > 0) {
                balanceText += ` + ${currentCredits.quizGenCredits} Quiz`;
            }
            document.getElementById('creditsInfo').textContent = balanceText;
            console.log('Updated credits display with current balance');
        }
    } catch (error) {
        console.log('Could not fetch current balance, keeping purchased credits display');
    }
    
    // Display payment details
    const detailsHtml = `
        <div class="detail-row">
            <span class="detail-label">Mã đơn hàng:</span>
            <span class="detail-value">${paymentData.orderCode || 'N/A'}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Số tiền:</span>
            <span class="detail-value">${formatAmount(paymentData.amount)}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Gói:</span>
            <span class="detail-value">${paymentData.planCode || 'N/A'}</span>
        </div>
        ${paymentData.chatCredits ? `
        <div class="detail-row">
            <span class="detail-label">Chat Credits:</span>
            <span class="detail-value">+${paymentData.chatCredits}</span>
        </div>
        ` : ''}
        ${paymentData.quizCredits ? `
        <div class="detail-row">
            <span class="detail-label">Quiz Credits:</span>
            <span class="detail-value">+${paymentData.quizCredits}</span>
        </div>
        ` : ''}
    `;
    document.getElementById('paymentDetails').innerHTML = detailsHtml;
    
    // Start countdown
    startCountdown();
}

// Show failed state
function showFailed(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('failedState').style.display = 'block';
    
    if (message) {
        document.getElementById('failedMessage').innerHTML = 
            `Rất tiếc, giao dịch của bạn không thành công.<br><strong>Lý do:</strong> ${message}`;
    }
}

// Show pending state
function showPending() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('pendingState').style.display = 'block';
}

// Countdown timer
function startCountdown() {
    let seconds = 5;
    const countdownEl = document.getElementById('countdown');
    
    const interval = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        
        if (seconds <= 0) {
            clearInterval(interval);
            goHome();
        }
    }, 1000);
}

// Navigation functions
function goHome() {
    window.location.href = '/index.html';
}

function retryPayment() {
    window.location.href = '/html/plans.html';
}

// Check status button handler
async function checkStatus() {
    const params = getUrlParams();
    if (params.orderCode) {
        document.getElementById('pendingState').style.display = 'none';
        document.getElementById('loadingState').style.display = 'block';
        await processPayment();
    }
}

// Main processing function
async function processPayment() {
    const params = getUrlParams();
    
    console.log('Payment result params:', params);
    
    if (!params.orderCode) {
        showFailed('Không tìm thấy mã đơn hàng');
        return;
    }
    
    // Check payment status from backend
    let paymentData;
    try {
        paymentData = await checkPaymentStatus(params.orderCode, params.token);
    } catch (error) {
        // Handle specific errors like token expiration
        showFailed(error.message);
        return;
    }

    if (!paymentData) {
        showFailed('Không thể kiểm tra trạng thái thanh toán');
        return;
    }
    
    console.log('Payment data:', paymentData);
    
    if (isPaymentSuccess(paymentData.status)) {
        await showSuccess(paymentData);
    } else if (isPaymentCreditFailed(paymentData.status)) {
        showFailed('Đã nhận tiền nhưng xử lý credit gặp lỗi. Vui lòng liên hệ hỗ trợ!');
    } else if (paymentData.status === 'FAILED') {
        showFailed('Thanh toán không thành công');
    } else if (paymentData.status === 'CANCELLED' || paymentData.status === 'EXPIRED') {
        showFailed('Thanh toán đã bị hủy hoặc hết hạn');
    } else {
        // Still pending or processing - show pending state
        showPending();
    }
}

// Main execution
window.addEventListener('DOMContentLoaded', async () => {
    console.log('Payment result page loaded');
    await processPayment();
});
</script>

</body>
</html>
